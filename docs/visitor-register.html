<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Event Registration</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
        }
        
        h2 {
            text-align: center;
            color: #333;
            margin-bottom: 25px;
            font-size: 28px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
            font-size: 14px;
        }
        
        input {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            box-sizing: border-box;
            font-size: 16px;
            transition: all 0.3s ease;
        }
        
        input:focus {
            outline: none;
            border-color: #25D366;
            box-shadow: 0 0 0 3px rgba(37, 211, 102, 0.1);
        }
        
        button {
            background: #25D366;
            color: white;
            padding: 14px;
            border: none;
            border-radius: 8px;
            width: 100%;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 10px;
        }
        
        button:hover:not(:disabled) {
            background: #128C7E;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(37, 211, 102, 0.3);
        }
        
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }
        
        .hidden {
            display: none;
        }
        
        .loading {
            text-align: center;
            color: #666;
            margin: 20px 0;
            font-size: 16px;
        }
        
        .success-message {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
            padding: 12px;
            margin: 10px 0;
            border-radius: 8px;
            text-align: center;
            font-weight: 600;
        }
        
        .error-message {
            background: #fee;
            border: 1px solid #fcc;
            color: #c33;
            padding: 12px;
            margin: 10px 0;
            border-radius: 8px;
            text-align: center;
            font-weight: 600;
        }
        
        .field-error {
            border: 2px solid #ff4444 !important;
            background-color: #fff9f9 !important;
        }
        
        .field-error:focus {
            outline: none;
            border-color: #ff4444 !important;
            box-shadow: 0 0 0 3px rgba(255, 68, 68, 0.2);
        }
        
        .help-text {
            font-size: 12px;
            color: #666;
            margin-top: 4px;
        }
        
        select {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            box-sizing: border-box;
            font-size: 16px;
            transition: all 0.3s ease;
            background-color: #fff;
        }
        
        select:focus {
            outline: none;
            border-color: #25D366;
            box-shadow: 0 0 0 3px rgba(37, 211, 102, 0.1);
        }
        
        select:disabled {
            background-color: #f5f5f5;
            cursor: not-allowed;
            opacity: 0.6;
        }
        
        .radio-group, .checkbox-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 8px;
        }
        
        .radio-option, .checkbox-option {
            display: flex;
            align-items: center;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            background-color: #fff;
        }
        
        .radio-option:hover, .checkbox-option:hover {
            border-color: #25D366;
            background-color: #f0fdf4;
        }
        
        .radio-option input[type="radio"],
        .checkbox-option input[type="checkbox"] {
            width: auto;
            margin-right: 10px;
            cursor: pointer;
        }
        
        .radio-option input[type="radio"]:checked + label,
        .checkbox-option input[type="checkbox"]:checked + label {
            font-weight: 600;
            color: #25D366;
        }
        
        .radio-option:has(input[type="radio"]:checked),
        .checkbox-option:has(input[type="checkbox"]:checked) {
            border-color: #25D366;
            background-color: #f0fdf4;
        }
        
        .radio-option label,
        .checkbox-option label {
            margin: 0;
            cursor: pointer;
            flex: 1;
        }
        
        .multi-select-container {
            display: flex;
            flex-direction: column;
            gap: 8px;
            max-height: 200px;
            overflow-y: auto;
            padding: 8px;
            border: 2px solid #ddd;
            border-radius: 8px;
            background-color: #fff;
        }
        
        .consent-section {
            background-color: #f8f9fa;
            border: 2px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            margin: 20px 0;
        }
        
        .consent-section h3 {
            font-size: 16px;
            margin-bottom: 12px;
            color: #333;
        }
        
        .consent-section ul {
            margin: 10px 0;
            padding-left: 20px;
        }
        
        .consent-section li {
            margin: 8px 0;
            font-size: 14px;
            line-height: 1.5;
            color: #555;
        }
        
        .consent-checkbox {
            display: flex;
            align-items: flex-start;
            margin-top: 15px;
            padding: 12px;
            background-color: #fff;
            border: 2px solid #ddd;
            border-radius: 8px;
        }
        
        .consent-checkbox input[type="checkbox"] {
            width: auto;
            margin-right: 10px;
            margin-top: 3px;
        }
        
        .consent-checkbox label {
            margin: 0;
            font-size: 14px;
            line-height: 1.5;
            cursor: pointer;
        }
        
        .others-specify {
            margin-top: 10px;
            display: none;
        }
        
        .others-specify.show {
            display: block;
        }
        
        .others-specify input {
            width: 100%;
        }
    </style>
</head>
<body>
    <h2>üé™ Event Registration</h2>
    
    <div id="messageContainer"></div>
    
    <form id="registrationForm">
        <div class="form-group">
            <label for="nameField">Full Name *</label>
            <input type="text" name="name" required id="nameField" 
                   placeholder="Enter your full name" 
                   aria-required="true">
        </div>
        
        <div class="form-group">
            <label for="phoneField">Phone Number *</label>
            <input type="tel" name="phone" required id="phoneField" 
                   placeholder="e.g., 012-345-6789" 
                   aria-required="true">
            <div class="help-text">Format: 012-345-6789</div>
        </div>
        
        <div class="form-group">
            <label for="emailField">Email (Optional)</label>
            <input type="email" name="email" id="emailField" 
                   placeholder="your.email@example.com">
        </div>
        
        <div class="form-group">
            <label>Gender *</label>
            <div class="radio-group">
                <div class="radio-option">
                    <input type="radio" name="gender" id="genderMale" value="Male" required>
                    <label for="genderMale">Male</label>
                </div>
                <div class="radio-option">
                    <input type="radio" name="gender" id="genderFemale" value="Female" required>
                    <label for="genderFemale">Female</label>
                </div>
                <div class="radio-option">
                    <input type="radio" name="gender" id="genderPreferNot" value="Prefer Not to Say" required>
                    <label for="genderPreferNot">Prefer Not to Say</label>
                </div>
            </div>
        </div>
        
        <div class="form-group">
            <label>Age Group *</label>
            <div class="radio-group">
                <div class="radio-option">
                    <input type="radio" name="age_group" id="ageLess18" value="less than 18 years" required>
                    <label for="ageLess18">Less than 18 years</label>
                </div>
                <div class="radio-option">
                    <input type="radio" name="age_group" id="age18_24" value="18-24 years" required>
                    <label for="age18_24">18-24 years</label>
                </div>
                <div class="radio-option">
                    <input type="radio" name="age_group" id="age25_34" value="25-34 years" required>
                    <label for="age25_34">25-34 years</label>
                </div>
                <div class="radio-option">
                    <input type="radio" name="age_group" id="age35_44" value="35-44 years" required>
                    <label for="age35_44">35-44 years</label>
                </div>
                <div class="radio-option">
                    <input type="radio" name="age_group" id="age45_54" value="45-54 years" required>
                    <label for="age45_54">45-54 years</label>
                </div>
                <div class="radio-option">
                    <input type="radio" name="age_group" id="ageMore55" value="more than 55 years" required>
                    <label for="ageMore55">More than 55 years</label>
                </div>
            </div>
        </div>
        
        <div class="form-group">
            <label for="countryField">Country of Origin *</label>
            <select name="country" id="countryField" required>
                <option value="Malaysia" selected>Malaysia</option>
                <option value="Singapore">Singapore</option>
                <option value="Thailand">Thailand</option>
                <option value="Indonesia">Indonesia</option>
                <option value="Brunei">Brunei</option>
                <option value="Philippines">Philippines</option>
                <option value="Vietnam">Vietnam</option>
                <option value="Myanmar">Myanmar</option>
                <option value="Cambodia">Cambodia</option>
                <option value="Laos">Laos</option>
                <option value="China">China</option>
                <option value="India">India</option>
                <option value="Bangladesh">Bangladesh</option>
                <option value="Pakistan">Pakistan</option>
                <option value="Sri Lanka">Sri Lanka</option>
                <option value="Japan">Japan</option>
                <option value="South Korea">South Korea</option>
                <option value="Australia">Australia</option>
                <option value="New Zealand">New Zealand</option>
                <option value="United Kingdom">United Kingdom</option>
                <option value="United States">United States</option>
                <option value="Canada">Canada</option>
                <option value="Other">Other</option>
            </select>
        </div>
        
        <div class="form-group">
            <label for="stateField">State of Origin *</label>
            <select name="state" id="stateField" required>
                <option value="">Select state</option>
                <option value="Johor">Johor</option>
                <option value="Kedah">Kedah</option>
                <option value="Kelantan">Kelantan</option>
                <option value="Melaka">Melaka</option>
                <option value="Negeri Sembilan">Negeri Sembilan</option>
                <option value="Pahang">Pahang</option>
                <option value="Perak">Perak</option>
                <option value="Perlis">Perlis</option>
                <option value="Pulau Pinang">Pulau Pinang</option>
                <option value="Sabah">Sabah</option>
                <option value="Sarawak">Sarawak</option>
                <option value="Selangor">Selangor</option>
                <option value="Terengganu">Terengganu</option>
                <option value="WP Kuala Lumpur">WP Kuala Lumpur</option>
                <option value="WP Labuan">WP Labuan</option>
                <option value="WP Putrajaya">WP Putrajaya</option>
            </select>
        </div>
        
        <div class="form-group">
            <label>Monthly Salary Group *</label>
            <div class="radio-group">
                <div class="radio-option">
                    <input type="radio" name="salary_group" id="salaryLess2k" value="less than RM2,000" required>
                    <label for="salaryLess2k">Less than RM2,000</label>
                </div>
                <div class="radio-option">
                    <input type="radio" name="salary_group" id="salary2k_5k" value="RM2,001-RM5,000" required>
                    <label for="salary2k_5k">RM2,001-RM5,000</label>
                </div>
                <div class="radio-option">
                    <input type="radio" name="salary_group" id="salary5k_10k" value="RM5,001-RM10,000" required>
                    <label for="salary5k_10k">RM5,001-RM10,000</label>
                </div>
                <div class="radio-option">
                    <input type="radio" name="salary_group" id="salaryMore10k" value="more than RM10,000" required>
                    <label for="salaryMore10k">More than RM10,000</label>
                </div>
            </div>
        </div>
        
        <div class="form-group">
            <label>Interest * (Select all that apply)</label>
            <div class="multi-select-container checkbox-group">
                <div class="checkbox-option">
                    <input type="checkbox" name="interest" id="interestTech" value="Technology">
                    <label for="interestTech">Technology</label>
                </div>
                <div class="checkbox-option">
                    <input type="checkbox" name="interest" id="interestFashion" value="Fashion">
                    <label for="interestFashion">Fashion</label>
                </div>
                <div class="checkbox-option">
                    <input type="checkbox" name="interest" id="interestBusiness" value="Business">
                    <label for="interestBusiness">Business</label>
                </div>
                <div class="checkbox-option">
                    <input type="checkbox" name="interest" id="interestFNB" value="Food and Beverage">
                    <label for="interestFNB">Food and Beverage</label>
                </div>
                <div class="checkbox-option">
                    <input type="checkbox" name="interest" id="interestTravel" value="Travel">
                    <label for="interestTravel">Travel</label>
                </div>
                <div class="checkbox-option">
                    <input type="checkbox" name="interest" id="interestHealth" value="Health">
                    <label for="interestHealth">Health</label>
                </div>
                <div class="checkbox-option">
                    <input type="checkbox" name="interest" id="interestAgriculture" value="Agriculture">
                    <label for="interestAgriculture">Agriculture</label>
                </div>
                <div class="checkbox-option">
                    <input type="checkbox" name="interest" id="interestOthers" value="Others">
                    <label for="interestOthers">Others (please specify)</label>
                </div>
            </div>
            <div class="others-specify" id="othersSpecify">
                <input type="text" name="interest_others" id="interestOthersField" placeholder="Please specify">
            </div>
        </div>
        
        <div class="consent-section">
            <h3>Data Protection & Consent</h3>
            <p>By clicking REGISTER, you agree to the following:</p>
            <ul>
                <li><strong>Consent to Data Processing:</strong> Your personal data will be collected by Pintar Web Enterprise for the purposes of managing the grand prize draw and providing a report to the convention organizers and participating vendors.</li>
                <li><strong>Anonymous Aggregation:</strong> Your data, along with other participants', may be used in an anonymous, aggregated form for event analysis and marketing research.</li>
                <li><strong>Vendor Communication:</strong> By submitting your information, you agree that your name and email may be shared with the specific vendor(s) whose QR code you scanned so they can send you marketing materials.</li>
            </ul>
            <p style="margin-top: 10px; font-size: 13px; color: #666;">
                Your personal data will be processed in accordance with the Personal Data Protection Act (PDPA) 2010 of Malaysia. You have the right to access and correct your personal data. For more information, please contact us at <a href="mailto:admin@pintarweb.com.my">admin@pintarweb.com.my</a>.
            </p>
            <div class="consent-checkbox">
                <input type="checkbox" name="consent" id="consentField" required>
                <label for="consentField">I have read and agree to the Data Protection & Consent terms above *</label>
            </div>
        </div>
        
        <input type="hidden" name="vendor_id" id="vendorId">
        
        <button type="submit" id="submitBtn">Register & Get Your Event Pass</button>
    </form>

    <div id="loading" class="hidden loading">‚è≥ Creating your event pass...</div>

    <script>
        // Configuration
        const N8N_WEBHOOK_URL = 'https://n8n.pintarweb.com/webhook/visitor-register';
        
        // Get vendor_id from URL
        const urlParams = new URLSearchParams(window.location.search);
        const vendorId = urlParams.get('vendor_id') || '';
        document.getElementById('vendorId').value = vendorId;
        
        // Country/State logic - enable state only if country is Malaysia
        const countryField = document.getElementById('countryField');
        const stateField = document.getElementById('stateField');
        
        function updateStateField() {
            if (countryField.value === 'Malaysia') {
                stateField.disabled = false;
                stateField.required = true;
            } else {
                stateField.disabled = true;
                stateField.required = false;
                stateField.value = '';
            }
        }
        
        countryField.addEventListener('change', updateStateField);
        updateStateField(); // Initialize on page load
        
        // Handle "Others" interest checkbox
        const interestOthersCheckbox = document.getElementById('interestOthers');
        const othersSpecifyDiv = document.getElementById('othersSpecify');
        const interestOthersField = document.getElementById('interestOthersField');
        
        interestOthersCheckbox.addEventListener('change', function() {
            if (this.checked) {
                othersSpecifyDiv.classList.add('show');
                interestOthersField.required = true;
            } else {
                othersSpecifyDiv.classList.remove('show');
                interestOthersField.required = false;
                interestOthersField.value = '';
            }
        });

        // Phone number formatting
        function formatPhoneNumber(value) {
            // Remove all non-digits
            const phoneNumber = value.replace(/\D/g, '');
            
            // Format based on length (Malaysian format: XXX-XXX-XXXX)
            if (phoneNumber.length <= 3) return phoneNumber;
            if (phoneNumber.length <= 6) {
                return phoneNumber.slice(0, 3) + '-' + phoneNumber.slice(3);
            }
            if (phoneNumber.length <= 9) {
                return phoneNumber.slice(0, 3) + '-' + phoneNumber.slice(3, 6) + '-' + phoneNumber.slice(6);
            }
            return phoneNumber.slice(0, 3) + '-' + phoneNumber.slice(3, 6) + '-' + phoneNumber.slice(6, 9) + '-' + phoneNumber.slice(9, 12);
        }

        // Phone input formatting
        const phoneField = document.getElementById('phoneField');
        phoneField.addEventListener('input', function(e) {
            const cursorPosition = e.target.selectionStart;
            const formatted = formatPhoneNumber(e.target.value);
            e.target.value = formatted;
            
            // Restore cursor position
            const newCursorPosition = cursorPosition + (formatted.length - e.target.value.length);
            e.target.setSelectionRange(newCursorPosition, newCursorPosition);
        });

        // Email validation
        function validateEmail(email) {
            if (!email) return true; // Email is optional
            const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return re.test(email);
        }

        // Phone validation
        function validatePhone(phone) {
            const digitsOnly = phone.replace(/\D/g, '');
            return digitsOnly.length >= 10 && digitsOnly.length <= 15;
        }

        // Helper function to show success messages
        function showSuccess(message) {
            const container = document.getElementById('messageContainer');
            container.innerHTML = '';
            
            const successElement = document.createElement('div');
            successElement.className = 'success-message';
            successElement.textContent = message;
            
            container.appendChild(successElement);
        }

        // Helper function to show error messages
        function showError(message) {
            const container = document.getElementById('messageContainer');
            container.innerHTML = '';
            
            const errorElement = document.createElement('div');
            errorElement.className = 'error-message';
            errorElement.textContent = message;
            
            container.appendChild(errorElement);
        }

        // Helper function to clear and highlight duplicate fields
        function handleDuplicateFields(duplicateFields) {
            // Remove highlights from all fields first
            document.querySelectorAll('input').forEach(input => {
                input.classList.remove('field-error');
                if (input.id !== 'vendorId') {
                    input.placeholder = input.getAttribute('data-original-placeholder') || '';
                }
            });
            
            // Clear and highlight each duplicate field
            duplicateFields.forEach(fieldName => {
                const field = document.getElementById(fieldName + 'Field');
                if (field) {
                    // Store original placeholder
                    if (!field.getAttribute('data-original-placeholder')) {
                        field.setAttribute('data-original-placeholder', field.placeholder);
                    }
                    
                    // CLEAR the duplicate field value
                    field.value = '';
                    field.classList.add('field-error');
                    
                    // Add appropriate placeholder based on field type
                    if (fieldName === 'phone') {
                        field.placeholder = '‚ö†Ô∏è This number is already registered. Please use a different number.';
                    } else if (fieldName === 'email') {
                        field.placeholder = '‚ö†Ô∏è This email is already registered. Please use a different email.';
                    }
                }
            });
            
            // Focus on first duplicate field
            if (duplicateFields.length > 0) {
                const firstField = document.getElementById(duplicateFields[0] + 'Field');
                if (firstField) {
                    setTimeout(() => firstField.focus(), 100);
                }
            }
        }

        // Form submission handler
        document.getElementById('registrationForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const submitBtn = document.getElementById('submitBtn');
            const originalBtnText = submitBtn.textContent;
            
            // Show loading
            document.getElementById('loading').classList.remove('hidden');
            submitBtn.disabled = true;
            submitBtn.textContent = 'Registering...';
            
            // Clear any previous messages and field highlights
            document.getElementById('messageContainer').innerHTML = '';
            document.querySelectorAll('input').forEach(input => {
                input.classList.remove('field-error');
                if (input.id !== 'vendorId') {
                    const originalPlaceholder = input.getAttribute('data-original-placeholder');
                    if (originalPlaceholder) {
                        input.placeholder = originalPlaceholder;
                    }
                }
            });
            
            // Collect form data including checkboxes and radio buttons
            const formData = new FormData(this);
            const data = {};
            
            // Get all form fields
            for (const [key, value] of formData.entries()) {
                if (key === 'interest') {
                    // Handle multiple interests (checkboxes)
                    if (!data.interest) {
                        data.interest = [];
                    }
                    data.interest.push(value);
                } else {
                    data[key] = value;
                }
            }
            
            // Convert interest array to comma-separated string for API
            if (data.interest && Array.isArray(data.interest)) {
                data.interest = data.interest.join(',');
            }
            
            // Add interest_others if "Others" is selected
            if (data.interest && data.interest.includes('Others') && data.interest_others) {
                data.interest = data.interest.replace('Others', `Others: ${data.interest_others}`);
            }
            
            // Client-side validation
            if (!data.name || data.name.trim().length < 2) {
                showError('Please enter a valid name (at least 2 characters)');
                document.getElementById('nameField').classList.add('field-error');
                document.getElementById('loading').classList.add('hidden');
                submitBtn.disabled = false;
                submitBtn.textContent = originalBtnText;
                return;
            }
            
            if (!validatePhone(data.phone)) {
                showError('Please enter a valid phone number (10-15 digits)');
                document.getElementById('phoneField').classList.add('field-error');
                document.getElementById('loading').classList.add('hidden');
                submitBtn.disabled = false;
                submitBtn.textContent = originalBtnText;
                return;
            }
            
            if (data.email && !validateEmail(data.email)) {
                showError('Please enter a valid email address');
                document.getElementById('emailField').classList.add('field-error');
                document.getElementById('loading').classList.add('hidden');
                submitBtn.disabled = false;
                submitBtn.textContent = originalBtnText;
                return;
            }
            
            // Validate at least one interest is selected
            const interests = formData.getAll('interest');
            if (!interests || interests.length === 0) {
                showError('Please select at least one interest');
                document.getElementById('loading').classList.add('hidden');
                submitBtn.disabled = false;
                submitBtn.textContent = originalBtnText;
                return;
            }
            
            // Validate "Others" interest has specification
            if (interests.includes('Others') && !data.interest_others?.trim()) {
                showError('Please specify your interest in the "Others" field');
                interestOthersField.classList.add('field-error');
                document.getElementById('loading').classList.add('hidden');
                submitBtn.disabled = false;
                submitBtn.textContent = originalBtnText;
                return;
            }
            
            // Validate consent
            if (!data.consent) {
                showError('Please agree to the Data Protection & Consent terms');
                document.getElementById('consentField').classList.add('field-error');
                document.getElementById('loading').classList.add('hidden');
                submitBtn.disabled = false;
                submitBtn.textContent = originalBtnText;
                return;
            }
            
            // Clean phone number (remove formatting for API)
            data.phone = data.phone.replace(/\D/g, '');
            
            try {
                const response = await fetch(N8N_WEBHOOK_URL, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });
                
                console.log('Response status:', response.status);
                
                let result;
                try {
                    result = await response.json();
                    console.log('Full response:', result);
                } catch (jsonError) {
                    console.error('JSON parse error:', jsonError);
                    showError('Server error. Please try again.');
                    document.getElementById('loading').classList.add('hidden');
                    submitBtn.disabled = false;
                    submitBtn.textContent = originalBtnText;
                    return;
                }
                
                if (response.ok) {
                    // Handle duplicate errors
                    if (result.success === false) {
                        let errorMessage = result.message || 'Registration failed';
                        
                        // Handle all three duplicate conditions
                        if (result.error === "duplicate_phone") {
                            errorMessage = "üì± This phone number is already registered. Please enter a different phone number.";
                            handleDuplicateFields(['phone']);
                        }
                        else if (result.error === "duplicate_email") {
                            errorMessage = "üìß This email address is already registered. Please enter a different email address.";
                            handleDuplicateFields(['email']);
                        }
                        else if (result.error === "duplicate_both") {
                            errorMessage = "üì±üìß Both phone number and email are already registered. Please enter different contact information.";
                            handleDuplicateFields(['phone', 'email']);
                        }
                        else if (result.duplicate_fields && result.duplicate_fields.length > 0) {
                            // Fallback: use duplicate_fields array if available
                            handleDuplicateFields(result.duplicate_fields);
                        }
                        
                        showError(errorMessage);
                        document.getElementById('loading').classList.add('hidden');
                        submitBtn.disabled = false;
                        submitBtn.textContent = originalBtnText;
                        return;
                    }
                    
                    // SUCCESS - show message and redirect
                    showSuccess('‚úÖ Registration successful! Redirecting to your pass...');
                    
                    // Save form data to localStorage for persistence
                    localStorage.setItem('last_registration', JSON.stringify({
                        name: data.name,
                        phone: data.phone,
                        email: data.email,
                        timestamp: new Date().toISOString()
                    }));
                    
                    // Redirect to pass page
                    const visitorName = data.name || result.name || 'Visitor';
                    const passUrl = result.pass_url || 
                        `https://pintarweb.github.io/event-data-system/pass.html?visitor_id=${result.visitor_id}`;
                    
                    // Build complete URL with all parameters
                    const url = new URL(passUrl);
                    url.searchParams.set('name', visitorName);
                    if (data.phone) url.searchParams.set('phone', data.phone);
                    if (data.email) url.searchParams.set('email', data.email);
                    if (result.total_points) url.searchParams.set('total_point', result.total_points);
                    
                    setTimeout(() => {
                        window.location.href = url.toString();
                    }, 1500);
                    
                } else {
                    // Handle HTTP errors
                    const errorMsg = result.message || 'Registration failed. Please check your information and try again.';
                    showError(errorMsg);
                    document.getElementById('loading').classList.add('hidden');
                    submitBtn.disabled = false;
                    submitBtn.textContent = originalBtnText;
                }
            } catch (error) {
                console.error('Network error:', error);
                showError('Network error. Please check your connection and try again.');
                document.getElementById('loading').classList.add('hidden');
                submitBtn.disabled = false;
                submitBtn.textContent = originalBtnText;
            }
        });

        // Remove error styling when user starts typing in any field
        document.querySelectorAll('input').forEach(input => {
            input.addEventListener('input', function() {
                if (this.classList.contains('field-error')) {
                    this.classList.remove('field-error');
                    const originalPlaceholder = this.getAttribute('data-original-placeholder');
                    if (originalPlaceholder) {
                        this.placeholder = originalPlaceholder;
                    }
                }
            });
        });

        // Restore form data from localStorage if available
        window.addEventListener('load', function() {
            const saved = localStorage.getItem('last_registration');
            if (saved) {
                try {
                    const data = JSON.parse(saved);
                    // Only restore if it's from today
                    const savedDate = new Date(data.timestamp);
                    const today = new Date();
                    if (savedDate.toDateString() === today.toDateString()) {
                        if (data.name) document.getElementById('nameField').value = data.name;
                        if (data.phone) document.getElementById('phoneField').value = formatPhoneNumber(data.phone);
                        if (data.email) document.getElementById('emailField').value = data.email;
                    }
                } catch (e) {
                    console.log('Could not restore form data');
                }
            }
        });
    </script>
</body>
</html>