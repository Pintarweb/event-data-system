<!DOCTYPE html>
<html>
<head>
    <title>Event Registration</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body { font-family: Arial, sans-serif; max-width: 500px; margin: 0 auto; padding: 20px; }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        input { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; }
        button { background: #25D366; color: white; padding: 12px; border: none; border-radius: 5px; width: 100%; font-size: 16px; cursor: pointer; }
        .hidden { display: none; }
        .loading { text-align: center; color: #666; margin: 20px 0; }
        .error-message {
            background: #fee;
            border: 1px solid #fcc;
            color: #c33;
            padding: 12px;
            margin: 10px 0;
            border-radius: 4px;
            text-align: center;
            font-weight: bold;
        }
        .retry-options {
            margin: 15px 0;
            text-align: center;
        }
        .retry-btn {
            background: #ff9900;
            margin: 5px;
            padding: 8px 15px;
            width: auto;
            display: inline-block;
        }
        .success-btn {
            background: #25D366;
            margin: 5px;
            padding: 8px 15px;
            width: auto;
            display: inline-block;
        }
        .field-error {
            border: 2px solid #ff9999 !important;
            background-color: #fff9f9 !important;
        }
        .retry-buttons-container {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 15px;
        }
        .retry-buttons-container button {
            flex: 1;
            min-width: 140px;
        }
    </style>
</head>
<body>
    <h2>üé™ Event Registration</h2>
    
    <div id="messageContainer"></div>
    
    <form id="registrationForm">
        <div class="form-group">
            <label>Full Name</label>
            <input type="text" name="name" required id="nameField">
        </div>
        <div class="form-group">
            <label>Phone Number</label>
            <input type="tel" name="phone" required id="phoneField">
        </div>
        <div class="form-group">
            <label>Email (Optional)</label>
            <input type="email" name="email" id="emailField">
        </div>
        <input type="hidden" name="vendor_id" id="vendorId">
        <button type="submit" id="submitBtn">Register & Get Your Event Pass</button>
    </form>

    <div id="loading" class="hidden loading">‚è≥ Creating your event pass...</div>

    <script>
        // Get vendor_id from URL
        const urlParams = new URLSearchParams(window.location.search);
        const vendorId = urlParams.get('vendor_id') || '';
        document.getElementById('vendorId').value = vendorId;

        // Helper function to show messages
        function showMessage(message, type = 'error', options = {}) {
            const container = document.getElementById('messageContainer');
            container.innerHTML = '';
            
            const messageElement = document.createElement('div');
            messageElement.className = type === 'error' ? 'error-message' : 'success-message';
            messageElement.innerHTML = message;
            
            // Add retry options for duplicate errors
            if (type === 'error' && options.retryOptions) {
                const retryDiv = document.createElement('div');
                retryDiv.className = 'retry-options';
                
                const buttonsContainer = document.createElement('div');
                buttonsContainer.className = 'retry-buttons-container';
                
                if (options.retryOptions.canRetry) {
                    const retryBtn = document.createElement('button');
                    retryBtn.type = 'button';
                    retryBtn.className = 'retry-btn';
                    retryBtn.textContent = 'üîÑ Try Different Info';
                    retryBtn.onclick = function() {
                        console.log('Try Again clicked');
                        if (options.retryOptions.onRetry) {
                            options.retryOptions.onRetry();
                        }
                    };
                    buttonsContainer.appendChild(retryBtn);
                }
                
                if (options.retryOptions.hasExistingPass) {
                    const viewPassBtn = document.createElement('button');
                    viewPassBtn.type = 'button';
                    viewPassBtn.className = 'success-btn';
                    viewPassBtn.textContent = 'üé´ View Existing Pass';
                    viewPassBtn.onclick = function() {
                        console.log('View Pass clicked');
                        if (options.retryOptions.onViewPass) {
                            options.retryOptions.onViewPass();
                        }
                    };
                    buttonsContainer.appendChild(viewPassBtn);
                }
                
                retryDiv.appendChild(buttonsContainer);
                messageElement.appendChild(retryDiv);
            }
            
            container.appendChild(messageElement);
        }

        // Helper function to clear and highlight duplicate fields
        function handleDuplicateFields(duplicateFields) {
            console.log('Clearing duplicate fields:', duplicateFields);
            
            duplicateFields.forEach(fieldName => {
                const field = document.getElementById(fieldName + 'Field');
                if (field) {
                    // Clear the field and add visual feedback
                    field.value = '';
                    field.classList.add('field-error');
                    field.placeholder = `Please use a different ${fieldName}`;
                    
                    console.log(`Cleared field: ${fieldName}`);
                    
                    // Remove error styling when user starts typing
                    const removeErrorStyle = () => {
                        field.classList.remove('field-error');
                        field.removeEventListener('input', removeErrorStyle);
                    };
                    field.addEventListener('input', removeErrorStyle);
                }
            });
            
            // Focus on first duplicate field
            const firstField = document.getElementById(duplicateFields[0] + 'Field');
            if (firstField) {
                firstField.focus();
            }
            
            // Clear the message container
            document.getElementById('messageContainer').innerHTML = '';
        }

        document.getElementById('registrationForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const submitBtn = document.getElementById('submitBtn');
            const originalBtnText = submitBtn.textContent;
            
            // Show loading
            document.getElementById('loading').classList.remove('hidden');
            submitBtn.disabled = true;
            submitBtn.textContent = 'Registering...';
            
            // Clear any previous messages
            document.getElementById('messageContainer').innerHTML = '';
            
            const formData = new FormData(this);
            const data = Object.fromEntries(formData);
            
            try {
                const response = await fetch('https://n8n.pintarweb.com/webhook/visitor-register', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                
                console.log('Response status:', response.status);
                
                // Check if response has content before parsing JSON
                let result;
                const responseText = await response.text();
                
                if (responseText) {
                    try {
                        result = JSON.parse(responseText);
                        console.log('Full response:', result);
                    } catch (parseError) {
                        console.error('JSON Parse Error:', parseError);
                        console.log('Raw response:', responseText);
                        throw new Error('Invalid server response');
                    }
                } else {
                    console.log('Empty response from server');
                    throw new Error('Empty server response');
                }
                
                if (response.ok) {
                    // Handle duplicate errors
                    if (result.success === false) {
                        let duplicateFields = [];
                        let message = '';
                        let hasExistingPass = false;
                        
                        if (result.error === "duplicate_phone") {
                            duplicateFields = ['phone'];
                            message = "üì± This phone number is already registered!";
                            hasExistingPass = !!result.existing_visitor?.visitor_id;
                        }
                        else if (result.error === "duplicate_email") {
                            duplicateFields = ['email'];
                            message = "üìß This email address is already registered!";
                            hasExistingPass = !!result.existing_visitor?.visitor_id;
                        }
                        else if (result.error === "duplicate_both") {
                            duplicateFields = ['phone', 'email'];
                            message = "üì±üìß Both phone number and email are already registered!";
                            hasExistingPass = !!result.existing_visitor?.visitor_id;
                        }
                        else {
                            message = "Registration failed: " + (result.message || "Unknown error");
                        }
                        
                        console.log('Duplicate fields detected:', duplicateFields);
                        console.log('Has existing pass:', hasExistingPass);
                        
                        // Show error with retry options
                        showMessage(message, 'error', {
                            retryOptions: {
                                canRetry: true,
                                hasExistingPass: hasExistingPass,
                                onRetry: () => {
                                    console.log('onRetry called with fields:', duplicateFields);
                                    handleDuplicateFields(duplicateFields);
                                },
                                onViewPass: () => {
                                    console.log('Redirecting to existing pass');
                                    const passUrl = `https://pintarweb.github.io/event-data-system/pass.html?visitor_id=${result.existing_visitor.visitor_id}&name=${encodeURIComponent(result.existing_visitor.name)}`;
                                    window.location.href = passUrl;
                                }
                            }
                        });
                        return;
                    }
                    
                    // SUCCESS - redirect to pass page
                    const visitorName = data.name || result.name || 'Visitor';
                    const passUrl = result.pass_url || `https://pintarweb.github.io/event-data-system/pass.html?visitor_id=${result.visitor_id}`;
                    window.location.href = `${passUrl}&name=${encodeURIComponent(visitorName)}`;
                    
                } else {
                    // Handle HTTP errors
                    let errorMessage = 'Registration failed. Please try again.';
                    if (response.status === 429) {
                        errorMessage += ' Too many attempts, please wait.';
                    }
                    
                    showMessage(errorMessage, 'error', {
                        retryOptions: {
                            canRetry: true,
                            hasExistingPass: false,
                            onRetry: () => {
                                document.getElementById('messageContainer').innerHTML = '';
                            }
                        }
                    });
                }
            } catch (error) {
                console.error('Error:', error);
                let errorMessage = 'Network error. Please check your connection.';
                
                if (error.message.includes('Invalid server response') || error.message.includes('Empty server response')) {
                    errorMessage = 'Server error. Please try again in a moment.';
                }
                
                showMessage(errorMessage, 'error', {
                    retryOptions: {
                        canRetry: true,
                        hasExistingPass: false,
                        onRetry: () => {
                            document.getElementById('messageContainer').innerHTML = '';
                        }
                    }
                });
            } finally {
                document.getElementById('loading').classList.add('hidden');
                submitBtn.disabled = false;
                submitBtn.textContent = originalBtnText;
            }
        });

        // Add input event listeners to remove error styling
        document.querySelectorAll('input').forEach(input => {
            input.addEventListener('input', function() {
                if (this.classList.contains('field-error')) {
                    this.classList.remove('field-error');
                    this.placeholder = '';
                }
            });
        });
    </script>
</body>
</html>